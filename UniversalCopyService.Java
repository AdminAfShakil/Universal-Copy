package com.my.universalcopy; // à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦¯à¦¾à¦•à§‡à¦œà§‡à¦° à¦¨à¦¾à¦® à¦¦à¦¿à¦¨

import android.accessibilityservice.AccessibilityService;
import android.accessibilityservice.AccessibilityServiceInfo;
import android.content.ClipData;
import android.content.ClipboardManager;
import android.content.Context;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityNodeInfo;
import android.widget.Toast;
import java.util.List;

public class UniversalCopyService extends AccessibilityService {

    @Override
    protected void onServiceConnected() {
        super.onServiceConnected();
        
        // à§§. à¦¸à¦¾à¦°à§à¦­à¦¿à¦¸ à¦•à¦¨à¦«à¦¿à¦—à¦¾à¦°à§‡à¦¶à¦¨
        AccessibilityServiceInfo info = new AccessibilityServiceInfo();
        info.eventTypes = AccessibilityEvent.TYPE_VIEW_CLICKED | AccessibilityEvent.TYPE_VIEW_LONG_CLICKED;
        info.feedbackType = AccessibilityServiceInfo.FEEDBACK_GENERIC;
        info.flags = AccessibilityServiceInfo.FLAG_REPORT_VIEW_IDS | 
                     AccessibilityServiceInfo.FLAG_RETRIEVE_INTERACTIVE_WINDOWS;
        
        this.setServiceInfo(info);
        
        // à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦œà¦¾à¦¨à¦¾à¦¨à§‹ à¦¯à§‡ à¦¸à¦¾à¦°à§à¦­à¦¿à¦¸ à¦šà¦¾à¦²à§ à¦¹à§Ÿà§‡à¦›à§‡
        Toast.makeText(this, "à¦‡à¦‰à¦¨à¦¿à¦­à¦¾à¦°à§à¦¸à¦¾à¦² à¦•à¦ªà¦¿ à¦šà¦¾à¦²à§ à¦¹à§Ÿà§‡à¦›à§‡! ðŸš€", Toast.LENGTH_SHORT).show();
    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        // à¦Ÿà¦¾à¦š à¦¬à¦¾ à¦²à¦‚ à¦ªà§à¦°à§‡à¦¸ à¦‡à¦­à§‡à¦¨à§à¦Ÿ à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¾
        if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_CLICKED || 
            event.getEventType() == AccessibilityEvent.TYPE_VIEW_LONG_CLICKED) {
            
            AccessibilityNodeInfo source = event.getSource();
            if (source == null) return;

            // à¦Ÿà¦¾à¦š à¦•à¦°à¦¾ à¦œà¦¾à§Ÿà¦—à¦¾à¦° à¦²à§‡à¦–à¦¾ à¦¬à§‡à¦° à¦•à¦°à¦¾ à¦à¦¬à¦‚ à¦•à¦ªà¦¿ à¦•à¦°à¦¾
            if (source.getText() != null && source.getText().length() > 0) {
                copyToClipboard(source.getText().toString());
            } else {
                // à¦šà¦¾à¦‡à¦²à§à¦¡ à¦­à¦¿à¦‰ à¦–à§à¦à¦œà§‡ à¦Ÿà§‡à¦•à§à¦¸à¦Ÿ à¦¬à§‡à¦° à¦•à¦°à¦¾à¦° à¦šà§‡à¦·à§à¦Ÿà¦¾
                findChildText(source);
            }
        }
    }

    // à¦²à§à¦•à¦¾à¦¨à§‹ à¦Ÿà§‡à¦•à§à¦¸à¦Ÿ à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à¦¾à¦° à¦«à¦¾à¦‚à¦¶à¦¨
    private void findChildText(AccessibilityNodeInfo node) {
        if (node == null) return;
        
        if (node.getText() != null && node.getText().length() > 0) {
            copyToClipboard(node.getText().toString());
            return; 
        }

        for (int i = 0; i < node.getChildCount(); i++) {
            findChildText(node.getChild(i));
        }
    }

    // à¦•à§à¦²à¦¿à¦ªà¦¬à§‹à¦°à§à¦¡à§‡ à¦•à¦ªà¦¿ à¦•à¦°à¦¾à¦° à¦«à¦¾à¦‚à¦¶à¦¨
    private void copyToClipboard(String text) {
        ClipboardManager clipboard = (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);
        ClipData clip = ClipData.newPlainText("Copied Text", text);
        clipboard.setPrimaryClip(clip);
        
        // à¦›à§‹à¦Ÿ à¦Ÿà§‹à¦¸à§à¦Ÿ à¦®à§‡à¦¸à§‡à¦œ à¦¦à¦¿à§Ÿà§‡ à¦‡à¦‰à¦œà¦¾à¦°à¦•à§‡ à¦«à¦¿à¦¡à¦¬à§à¦¯à¦¾à¦• à¦¦à§‡à¦“à§Ÿà¦¾
        Toast.makeText(getApplicationContext(), "à¦•à¦ªà¦¿ à¦¹à§Ÿà§‡à¦›à§‡: " + text.substring(0, Math.min(text.length(), 20)) + "...", Toast.LENGTH_SHORT).show();
    }

    @Override
    public void onInterrupt() {
        // à¦¸à¦¾à¦°à§à¦­à¦¿à¦¸ à¦¬à¦¨à§à¦§ à¦¹à¦²à§‡
        Toast.makeText(this, "à¦‡à¦‰à¦¨à¦¿à¦­à¦¾à¦°à§à¦¸à¦¾à¦² à¦•à¦ªà¦¿ à¦¬à¦¨à§à¦§ à¦¹à¦²à§‹à¥¤", Toast.LENGTH_SHORT).show();
    }
}
